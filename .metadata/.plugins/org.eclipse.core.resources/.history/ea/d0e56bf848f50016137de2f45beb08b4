package org.fmaes.simulinktotimedautomata.platformextender.blockroutinegenerator.minmax;

import org.fmaes.simulinktotimedautomata.blockroutinegenerator.BlockRoutineGeneratorInterface;
import org.fmaes.simulinktotimedautomata.types.wrappers.Predecessor;
import org.fmaes.simulinktotimedautomata.types.wrappers.SimulinkBlockWrapper;

public class MinMax implements BlockRoutineGeneratorInterface {

  @Override
  public String generateBlockRoutine(SimulinkBlockWrapper blockForParsing) {

    String blockR = "void blockRoutine(){#routineBody#;}";
    String outSignal = blockForParsing.getSignalName();
    /* you should read the correct one */
    String function = blockForParsing.getDeclaredParameter("Function");
    String operator = "<=";
    if (function != null || function.trim().equals("max")) {
      operator = ">=";
    }

    String routineBody = "";
    for (Predecessor prdcsr : blockForParsing.predecessors) {
      if (!prdcsr.getSimulinkBlock().exists()) {
        continue;
      }
      String predecessorCondition = "";
      int counter = 0;
      for (Predecessor predecessor : blockForParsing.predecessors) {
        if (predecessor.getSimulinkBlock().exists() && prdcsr.getSimulinkBlock()
            .getSignalName() != predecessor.getSimulinkBlock().getSignalName()) {
          if (counter == 0) {
            predecessorCondition =
                String.format("%s %s %s", prdcsr.getSimulinkBlock().getSignalName(), operator,
                    predecessor.getSimulinkBlock().getSignalName());
          } else {
            predecessorCondition +=
                String.format("&amp;&amp; %s %s %s", prdcsr.getSimulinkBlock().getSignalName(),
                    operator, predecessor.getSimulinkBlock().getSignalName());
          }
        }
        counter++;
      }
      String conditionFixed = String.format("if(%s){%s = %s;}\n", predecessorCondition, outSignal,
          prdcsr.getSimulinkBlock().getSignalName());
      routineBody += conditionFixed;
    }
    blockR = blockR.replace("#routineBody#", routineBody);
    return blockR;
  }

}
